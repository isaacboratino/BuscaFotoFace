<html>

<head>
    <title>Busca Fotos Facebook</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="assets/frameworks/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="assets/frameworks/bootstrap/dist/css/bootstrap-theme.min.css">

    <style>
        html {
            background-color: #FFCCE7;
        }
        
        body {
            background-color: none;
            padding: 10px;
        }
        /*#fotosFace a {
            float: left;
            width: 25%;
            background-color: #97B;
            width: 100%;
            height: 100%;
            display: block;
        }
        
        #fotosFace img {
            width: 100%;
            height: 100%;
        }
        
        #fotosFace span {
            float: left;
            width: 75%;
            background-color: #EFE;
        }
        
        #fotosFace>div {
            float: left;
            width: 50%;
            height: 150px;
        }*/
    </style>

</head>

<body>
    <h1>Buscador Fotos Sabor de Lembrança</h1>

    <script src="assets/frameworks/jquery/dist/jquery.min.js" />
    <script src="assets/frameworks/bootstrap/dist/js/bootstrap.min.js" />

    <script>
        var arrayTodasFotos = new Array;

        // Faz load do SDK do facebook de forma sincona
        (function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s);
            js.id = id;
            js.src = "//connect.facebook.net/pt_BR/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));


        window.fbAsyncInit = function() {
            FB.init({
                appId: '435187766689207',
                cookie: true,
                xfbml: true,
                version: 'v2.8'
            });

            FB.getLoginStatus(function(response) {
                statusChangeCallback(response);
            });

        };

        function statusChangeCallback(response) {
            console.log('statusChangeCallback');
            console.log(response);

            // for FB.getLoginStatus().
            if (response.status === 'connected') {
                // Ao se logar no faceboock execute esta function
                queryFacebookAPI("/140969332682491/feed?fields=id,name,picture,full_picture,message,object_id,parent_id,type,link,timeline_visibility&limit=100");

            } else if (response.status === 'not_authorized') {
                document.getElementById('status').innerHTML = 'Por favor se logue nesse aplicativo.';
                FB.login();

            } else {
                document.getElementById('status').innerHTML = 'Por favor se logue no Facebook.';
                FB.login();
            }
        }

        // Ao se logar, fas a busca no facebook com a api
        var contador = 0;

        function queryFacebookAPI(api_url) {
            console.log('Bem vindo a api face! Lendo informações.... ');

            FB.api(api_url,
                function(response) {
                    if (response && !response.error) {

                        arrayTodasFotos = response.data;
                        montaImagensTela(arrayTodasFotos, document.getElementById('fotosFace'));

                        // Se ainda não leu todas as paginas
                        if (response.data.length == 0) {
                            console.log('Next: ' + response.paging.next);
                            queryFacebookAPI(response.paging.next);
                        } else {
                            // se leu todas as paginas
                            criarDropdownSelecaoFotos();
                        }

                    }
                }
            );
        }

        // Checa se foi feito o login
        function checkLoginState() {
            FB.getLoginStatus(function(response) {
                statusChangeCallback(response);
            });
        }

        function montaImagensTela(arrayObjetos, divIncremental) {
            var fotosFace = '';

            for (i = 0; i < arrayObjetos.length; i++) {
                fotosFace += templateImages(arrayObjetos[i], ++contador);
            }

            document.getElementById('fotosFace').innerHTML = divIncremental.innerHTML + fotosFace;
        }

        function templateImages(linha, contador) {
            return '<div class="col-xs-6 col-md-3">' +
                '  <a href=' + linha.link + ' target=_blank class=thumbnail>' +
                '    <img src=\"' + linha.full_picture + '\" ' +
                '         style="height: 200px; width: 100%; display: block;" >' +
                '  </a>' +
                '</div>';
            /*+'  <span>' + contador + ' : ' + linha.message + '</span>'*/
        }

        function criarDropdownSelecaoFotos() {
            jQuery.inArray("urso", arrayTodasFotos);
            var arrayFotosSelecionadas = jQuery.grep(arrayTodasFotos, function(obj) {
                return obj.message.indexOf("urso");
            });
            montaImagensTela(arrayFotosSelecionadas, divIncremental)
        }
    </script>

    <fb:login-button scope="public_profile,email" onlogin="checkLoginState();">
    </fb:login-button>

    <div class="row" id="fotosFace">
    </div>



</body>

</html>